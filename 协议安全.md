# 概论
# 第一章 引入
## TCP/IP中的安全隐患
应用层、传输层、网络层、链路层
1. 信息嗅探:
    - 在交换式网络环境中，ARP地址解析协议存在隐患。ARP协议负责动态解析IP地址与物理MAC地址，缓存中存储$IP_a/MAC_a$
    - 当$AB$双方通信时，只要偷听方$H$截获所有保文，并修改ARP应答报文为$IP_A/MAC_H$和$IP_B/MAC_H$即可。$H$在偷听到信息后重发即可。
2. 信息篡改： 
   - $H$嗅探信息后重放时可以选择修改数据，增加木马病毒等。
3. 身份欺骗
   - IP欺骗、DNS欺骗
4. 行为否认
   - 发送方否认自己已经发送过数据，或接收方否认自己收到了数据的行为。
   - 例如IP欺骗，发送方使用假IP发送数据。
## 网络安全需求
- 机密性：防止偷听
- 完整性：防止篡改
- 可控性：防止未授权的访问和修改。标识、鉴别、授权、决策、执行。**访问控制**:首先赋予每一个通信实体唯一的标识和访问权限，访问时先验证身份后执行相应访问控制策略。
- 不可否认性:不可抵赖。
- 可用性：合法用户需要使用时能够使用：DDos等拒绝服务攻击。
## 构建网络安全协议需要的组件**(密码原语)**
    1. 加解密(机密性)：公钥密码（非对称，RSA、数字签名算法DSA、椭圆曲线算法ECC）和私钥密码（对称，AES、3DES、IDEA、RC2、RC4）。
    2. 消息摘要(完整性)：
        - MD5(Message Digest 5)、SHA-1(Secure Hash Algorithm)
        - 表征该数据特征。一般用Hash（散列函数）完成，**多个输入可能对应同一个输出**。如：校验和。
        - 散列函数的要求：
            2. 单向性：快速计算出H(M)，但构造逆函数$H^-1(M)$不可行。  
            3. 抗冲突性：弱抗冲突性：给定M，计算上给不出M'，使H(M)=H(M')；强抗冲突性：找不出任何一对M,M'，使H(M)=H(M')
            - 通常满足抗冲突性，**且抗冲突性的强度是长度一半**(128位散列值抗64位冲突，$2^64$次操作后才冲突)。
    3. 消息验证码：基于密钥和消息摘要获得的值，用于**数据源发认证、完整性校验**
        - ![消息验证码](消息验证码验证流程.jpg)
        - 可以使用DES加密；或使用专门的MAC算法HMAC(Hash based Message Authentication Code)
    4. 数字签名：基于数字签名。与消息验证码类似，但使用发送方私钥加密，接收方用发送方的公钥解密（**不对称密码**）。DSA/RSA。
## 密钥管理
1. 基于可信第三方：KDC(Key Distribution Centre)
    - Kerberos使用过。
    - ![KDC密钥管理](d75527643651ff6710657159ae125163_720.png)
2. 密钥协商算法(共享密钥生成素材)：
    - Diffle-Hellman（DF算法）：双方共享大素数p、发生器g。g是公开的，且总是存在W,使$g^W \mod p = Z$,Z是小于p的所有数。
    - ![D-F](image-2.png)
3. 公钥管理：
    - 共享密钥需要安全传输，一般使用公钥密码传输。
    - 直接在开放信道上传输公钥有中间人攻击。使用证书分发公钥，证书授权中心（CA，Certificate Authority，可信第三方 ）负责证书包含：拥有方的公钥（需要传输）、CA私钥加密的签名。
## 协议栈
- 端到端：应用、传输层；点对点：网络、链路层。**越底层的安全协议能保护所有上层协议**，但一般考虑内容更多，效率更低。对于特殊的高层应用，可以只考虑对于高层的安全协议。
![各个协议栈的安全协议](35bfd1037ab4ca0992bc06f9f6b211c2_720.png)
# 链路层拓展L2TP
对PPP点对点协议进行了拓展。



# 认证协议Kerberos
主要面向**实体身份认证**
- 对称密码、可信第三方、票据Ticket。用户访问服务器之前必须使用对称密码通过可信第三方获得票据后才可以通信。
## 认证过程
- ![Kerberos通信过程](0c1ba3316ef754c5a8761102ee6c6f61_720.png)
- 用户：Client c，持有密钥$\{K_{AS,c},K_{c,tgs}(由AS生成),K_{c,v}(由tgs生成)\}$。
- 可信第三方(KDC):
    - 认证服务器:AS，持有密钥$\{K_{AS,c}(预先存储),K_{AS,tgs(用于告知tgs所生成的K_{c,tgs})}\}$。验证用户c的身份，并发放票据许可票据TGT。
    - 票据签发服务器Ticket Granting Server(tgs)。持有密钥$\{K_{c,tgs}（AS生成后告知）,K_{v,tgs}(用于告知服务器V生成的K_{c,v})\}$
- 服务器：V，持有密钥$\{K_{c,v}(由tgs生成并告知),K_{tgs,v}\}$
![AS、TGS、C、V相互通信](image-1.png)
1. 客户端c向AS认证服务器**直接发送**$\{ID_c(自己的身份id),ID_tgs(要访问的tgs的id),TS_1(时间戳)\,n_1(某个随机数)}$
2. AS收到后查询$ID_c$的密钥$K_{AS,c}$，并加密发送：
    1. 时间戳$TS_2$
    2. TGT(票据许可Ticket，tgs可解密):$E_{K_{AS,tgs}}(K_{c,tgs}(用于用户和tgs通信，tgs收到用户发送的票据后即可解密出),TS_2,ID_c)$
    3. ct1用户信息(用户可解密):$E_{K_{AS,c}}(K_{c,tgs},TS_2,ID_{tgs}(确认tgs),n_1)$
3. 客户端收到后解密ct1，验证$ID_{tgs}、n_1、TS_2$。向tgs发送:
    1. TGT
    2. 请求的服务器$ID_V$
    3. ct2:$E_{K_{c,tgs}}(ID_c,TS_3)$
    4. $n_2$随机数
4. tgs收到后生成一个c、v通信密钥$K_{c,v}$;解密TGT来获取$K_{c,tgs},ID_c,TS_2$，并验证$TS_2$。用得到的$K_{c,tgs}$解密ct2得到${ID_C}^{'}和TS_3$，验证之。并向客户端c回发：
    1. 票据STicket:$E_{K_{tgs,v}}(K_{c,v},Id_c,TS_4)$
    2. ct3用户信息:$E_{K_{c,tgs}}(K_{c,v},ID_v,TS_4,n_3)$
    3. $Id_c$
5. 用户收到后解密ct3，验证$TS_4,n_3,Id_v$。向服务器发送：
    1. 票据ST
    2. ct4：$E_{K_{c,v}}(id_c,TS_5)$
6. 服务器收到后解密ST，ct4；验证ST中的$TS_4$和ct4中的$Id_c和TS_5$。若成功则设置状态ACCEPT。回发ct5:$E_{K_{c,v}}(ST_6)$
7. 收到ct5后验证$ST_6$，并设置ACCEPT，开始通信。
## 票据与认证符
1. 初始认证选项：
    - INITAL：无身份认证，若用户拥有$K_{c,AS}$则身份认证了
    - PRE-AUTHENT：要求用户请求AS前提供预认证；用自己的证书私钥加密本地时间戳。
    - HW-AUTHENT；HARDWARE-AUTH：硬件支持的预认证
2. 可更新票据：
    - RENEWABLE，设置两个生命周期，一个是票据生命周期，一个是更新生命周期。**在更新周期内可以设置RENEW选项来请求KDC获取新的票据，新的票据有新的密钥和生命周期**。
    - RENEABLE-OK：若客户端请求的生命周期得不到满足也能接受。
3. 可推迟票据：用户待会儿再用。在AS请求报文中增加ALLOW-POSTDATE，获取MAY-POSTDATE的TGT，再获取POSTDATED的票据。使用POSTDATED票据时需要请求KDC激活。（要加入INVALID和VALIDATE选项）
4. 无效票据：INVALID、VALIDATE
5. 代理功能：客户端请求一个代理为其完成对服务器的访问。在TGT中包含PROXIABLE，并指明代理的IP地址。ST中包含Proxy选项。
- ![票据格式](c8a471c72b5508e6e8f271e160db735e_720.png)
- ![认证符格式](cdf723e48bb6fcd31c1b305b8e174b5b.png)


# SSH协议
应用层协议，基于TCP端口22。机密性、完整性保护和身份认证。低层实现用户名口令加密保护数据；高层同时实现证书身份认证。
## 协议组成和功能
1. 传输层协议：协商，数据处理，规定各种加密、认证、散列等算法协商的报文格式和顺序。定义了密钥计算、数据处理方法。定义主机级（一个主机多个用户）身份认证。SSH最底层。包含了服务器身份认证。
2. 用户身份认证
3. 连接协议：分解安全通道到多个逻辑通道，**多个高层应用共享SSH安全服务**
- 高层应用FTP等 ← SSH连接协议 ← SSH用户认证 ← SSH传输层协议 ← TCP ← IP
## 协议流程
### 密钥交换
- 三项功能：**算法协商、D-H交换、计算密钥**。服务器认证信息包含在D-H交换中。
# SSH（协议以及内部流程，指令。指令具体不要求）
Secure Shell：安全命令解释器。提供账号
## SSH传输协议
- SSH流程
    1. 版本协商
    2. 密钥交换
        1. 算法协商
        2. ![算法协商报文](0ed26234e0a8c3ed84e5be39896e00f5_720.png)
    - ![SSH传输协议流程](46998879a6500807a1682a0476cd3c8e_720.png)
## 身份认证协议SSH
## SSH连接协议
传输层协议建立连接称为隧道，多个应用相互连接称为通道。一个隧道包含多个通道，即SSH连接可以**为多个应用提供安全服务**。
### 基本通道操作
![SSH连接协议基本通道操作](18d82d9ee82c8a58359e845c00f32e23_720.png)
1. SSH-MESSAGE-CHANNEL_OPEN

## SSH应用
- SFTP
- 基于SSH的VPN
- SSH产品

# DNS安全
## DNS
域名解析，实际是维护一张表格。 
- 域名命名：域名树，根节点顶级域(com)，二级域...总名字就是叶子节点回溯到根节点的名称序列，中间用.分割。如:com -> baidu -> www，连接www.baidu.com。
- 每个服务器负责维护一个子域。授权：负责大区域的服务器可以授权其他服务器负责维护其他子域。
- ![DNS树](6eea3ebadd7662030b287874de2b978b_720.png)
- 每个客户端仅需记录1-2个DNS服务器：每个服务器都知道上级/根DNS服务器地址；根DNS知道所有二级DNS服务器IP地址。
- 查询：
    1. 递归查询：客户默认DNS代理查询，有Cache则返回，没有则递归向上请求域名；
    2. 迭代查询；向上级请求可能存在Cache的服务器。
- DNS报文：ID 参数 问题、答案、权威数 附加记录数
    1. 问题区：查询域名、查询类型、查询类
    2. 答案区、权威区(授权服务器信息)、附加信息区
    3. ![DNS报文](image-3.png)
    4. ![DNS响应](image-4.png)
## DNS欺骗
- 中间人攻击：欺骗DNS响应报文，匹配ID和UDP端口即可
    - DNS欺骗
    - 猜测ID和UDP：伪造自己的IP地址为合法服务器地址；猜测ID和客户端UDP进行穷举
- DNS劫持：侵入DNS服务器，修改数据库
- 生日攻击：寻找16bit字符串(UDP端口),则碰撞攻击的复杂度通过生日攻击可以降到$2^8$个查询(即bit长度的一半)
- 名字连锁攻击：修改权威区、附加信息区(将恶意字段放在附加信息中，例如将恶意IP放入附加信息区，此后对正常的网址的访问会重定向到恶意IP)。
- 信任服务器背板：默认DNS服务器通过DHCP协议分配IP时，劫持DHCP服务器
- 否认合法域名存在
- 通配符:导致域名名称标识存在不确定性
- Kaminski攻击：利用不存在域名
## DNSSec协议
- DNS欺骗都是将正常请求定向到恶意网站，第一种是伪装DNS服务器，第二种是篡改DNS响应报文。则加入**认证机制**即可。**DNSsec使用数字签名提供身份认证和完整性校验，同时还有公钥分发技术。**，但没有Dos防护。
- DNSsec的拓展以资源记录RR形式保存，便于向后兼容和扩展性。
### 密钥使用
- 域签名密钥ZSK、密钥签名密钥KSK：
    1. 每个区域为每个算法配置一对公私钥(ZSK Zone Signing Key)
    2. 客户端验证签名用到DNS服务器的公钥，直接配置在DNS服务器或传输，使用另一对密钥进行签名(KSK Key Siging Key)。
    - 解析example.com域名，请求a.example.com时，收到一个标准DNS响应记录，和一个RRSIG记录(对example.com域的签名)，用example.com的私钥签名；再请求ZSK的公钥，则返回DNSKEY记录，使用KSK私钥签名的ZSK。
    - 使用认证链来进行认证。**一个域的公钥通过父域认证**。
- DNSKEY报文：标志(0-15 第7bit设置为1时表示区域密钥，则公钥属于当前域 第15bit表示安全入口点，为1时区域密钥必须为1) 协议(必须设置为3) 算法 公钥
- RRSIG：覆盖的类型：被签名的资源记录类型；原始TT：签名有效期。![RRSIG](b641bb0bd71a1763474c40fd939a3967_720.png)。存有ZSK私钥加密的签名，需要KSK私钥签名的公钥报文DNSKEY来认证这个RRSIG签名。
- DS：指示子域的DNSKEY资源记录，保存对于DNSKEY的密钥标签、签名算法和摘要
- NSEC：保存下一个域名和类型比特位图(表示当前RR的类型)。循环式存储，首先按照资源信息重要性排序，之后形成域名链，最后会回到第一个域名结束。

### DNSsec对DNS扩展
1. CName记录：域名的别名，要求必须包含一个RRSIG
2. DNS报文：报文中加入新参数
3. 增加参数字段进行扩展
4. 伪资源记录：报文长度增加后可能不能使用UDP，修改之
